---
// src/pages/abonnement.astro
import Layout from '~/layouts/Layout.astro';
---

<Layout metadata={{ title: 'Devenir Pionnier AeroX' }}>
  <section class="max-w-3xl mx-auto py-16 text-center">
    <h1 class="text-3xl md:text-4xl font-bold mb-6">ğŸš€ Rejoins les Pionniers AeroX</h1>
    <p class="text-muted mb-12">
      Tu nâ€™es pas seulement utilisateur. Tu es co-bÃ¢tisseur dâ€™une rÃ©volution cycliste.
    </p>

    <!-- Bloc 1 : avantages -->
    <div class="mb-16">
      <h2 class="text-2xl font-semibold mb-4">1. Les avantages pour toi</h2>
      <ul class="space-y-3 text-left max-w-lg mx-auto text-muted">
        <li>âœ… <strong>AccÃ¨s privilÃ©giÃ©</strong> : premier cercle dâ€™utilisateurs.</li>
        <li>âœ… <strong>Impact direct</strong> : tes retours faÃ§onnent AeroX.</li>
        <li>âœ… <strong>Tarif fondateur</strong> : une offre unique rÃ©servÃ©e aux pionniers.</li>
        <li>âœ… <strong>VisibilitÃ©</strong> : tu fais partie des premiers Ã  dÃ©mocratiser lâ€™aÃ©ro.</li>
      </ul>
    </div>

    <!-- Bloc 2 : enjeux -->
    <div class="mb-16">
      <h2 class="text-2xl font-semibold mb-4">2. Pourquoi une contribution payante ?</h2>
      <ul class="space-y-3 text-left max-w-lg mx-auto text-muted">
        <li>ğŸ’¡ <strong>Image extÃ©rieure</strong> : montrer quâ€™AeroX rÃ©pond Ã  un vrai besoin.</li>
        <li>ğŸ’¡ <strong>Force de traction financiÃ¨re</strong> : chaque pionnier renforce le projet.</li>
        <li>ğŸ’¡ <strong>Croissance</strong> : plus de mises Ã  jour, de tests, de stabilitÃ©.</li>
        <li>ğŸ’¡ <strong>CommunautÃ© vitrine</strong> : les pionniers deviennent la rÃ©fÃ©rence.</li>
      </ul>
    </div>

    <!-- Call to action -->
    <div class="flex flex-col items-center gap-2">
      <button
        id="btn-checkout"
        type="button"
        class="btn btn-primary px-8 py-3"
      >
        Devenir pionnier
      </button>
      <small class="text-xs text-muted">rÃ©servÃ© aux premiers utilisateurs engagÃ©s</small>
    </div>

    <p class="text-xs text-muted mt-6">
      Paiement sÃ©curisÃ© par Stripe. Ton engagement construit AeroX, et tu gardes ton avantage Ã  vie.
    </p>
  </section>


  <script is:inline>
    const callCheckout = async (payload = {}) => {
      const res = await fetch('/api/create-api-checkout', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const data = await res.json();
      if (data?.url) {
        window.location.href = data.url;
      } else {
        throw new Error(data?.error || 'Erreur Stripe');
      }
    };
    

    const withLoading = async (btn, fn) => {
      if (!btn) return;
      btn.disabled = true;
      const prev = btn.innerHTML;
      btn.innerHTML = 'Redirectionâ€¦';
      try {
        await fn();
      } catch (e) {
        alert(e?.message || e || 'Erreur');
        btn.disabled = false;
        btn.innerHTML = prev;
      }
    };

    // Bouton principal : aucun param â€” lâ€™API lira STRIPE_PRICE_ID / STRIPE_LOOKUP_KEY cÃ´tÃ© serveur
    document.getElementById('btn-checkout')?.addEventListener('click', (e) => {
      withLoading(e.currentTarget, () => callCheckout());
    });

    // Exemple : bouton alternatif qui passe un lookupKey public (facultatif)
    document.getElementById('btn-checkout-alt')?.addEventListener('click', (e) => {
      const key = e.currentTarget.getAttribute('data-lookup-key');
      withLoading(e.currentTarget, () => callCheckout({ lookupKey: key }));
    });
  </script>
</Layout>
