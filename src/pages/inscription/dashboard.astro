---
import Prices from '~/components/widgets/Pricing.astro';
import { supabase } from '~/config/supabaseClient';
import Layout from '~/layouts/PageLayout.astro';

const metadata = {
  title: 'Dashboard ‚Äî AeroX',
  description: "Ton espace personnel AeroX : abonnement, statut et acc√®s √† l'application.",
};

// üîπ Typage local pour la table users
type UserProfile = {
  role: 'admin' | 'user' | 'pionnier';
  is_active: boolean;
  licence_type: 'Pack D√©couverte' | 'Pack Pionnier' | 'Pack Progression' | string;
};

let user: { id: string; email: string } | null = null;
let subscription: UserProfile | null = null;

try {
  const { data: userData } = await supabase.auth.getUser();
  user = userData?.user
    ? { id: userData.user.id, email: userData.user.email ?? '' }
    : null;

  if (user) {
    const { data: profile, error } = await supabase
      .from('users')
      .select('role, is_active, licence_type')
      .eq('id', user.id)
      .single<UserProfile>();

    if (profile && !error) {
      subscription = profile;
    }
  }
} catch (err) {
  console.error('Erreur dashboard:', err);
}
---

<Layout metadata={metadata}>
  <section class="max-w-4xl mx-auto py-16 px-6">
    <h1 class="text-3xl font-bold mb-6 text-center">Bienvenue sur ton espace AeroX üö¥‚Äç‚ôÇÔ∏è</h1>

    {user ? (
      <div class="mb-12 text-center">
        <p class="text-lg">
          ‚úÖ Connect√© en tant que <span class="font-semibold">{user.email}</span>
        </p>

        {subscription ? (
          <div class="mt-4 p-6 border rounded-lg bg-gray-50 dark:bg-gray-800">
            <p><strong>R√¥le :</strong> {subscription.role}</p>
            <p><strong>Compte actif :</strong> {subscription.is_active ? 'Oui' : 'Non'}</p>
            <p><strong>Licence :</strong> {subscription.licence_type}</p>
          </div>
        ) : (
          <p class="mt-4 text-red-600">
            ‚ùå Aucun abonnement trouv√©. Choisis une offre ci-dessous üëá
          </p>
        )}
      </div>
    ) : (
      <div class="mb-12 text-center">
        <p class="text-red-600 font-semibold">
          ‚ùå Tu n‚Äôes pas connect√©. <a href="/inscription/connexion" class="underline text-primary hover:text-primary/80">Connecte-toi</a>.
        </p>
      </div>
    )}

    <!-- Cartes de prix -->
    <Prices
      title="Nos Offres"
      id="pricing"
      subtitle="Un pack pour chaque objectif"
      subsubtitle="D√©couvre les tarifs et abonnements AeroX pour cyclistes et triathl√®tes. Compare nos offres avec Zwift, MyWhoosh ou Kinomap et profite d‚Äôune solution unique pour ton home trainer connect√© (Tacx, Elite, Wahoo). Id√©al pour pr√©parer tes Ironman et tes entra√Ænements v√©lo indoor."
      prices={[
        {
          title: 'Pack D√©couverte',
          subtitle: 'Teste ton a√©ro',
          price: '5',
          period: 'pendant 10 jours',
          items: [
            { description: 'Acc√®s complet √† AeroX', icon: 'tabler:award-filled' },
            { description: "Teste jusqu'√† 1h/j", icon: 'tabler:award-filled' },
          ],
          callToAction: {
            target: '_blank',
            text: 'Lancement le 01/12/2025',
            href: '#',
          },
          hasRibbon: false,
          ribbonTitle: '',
        },
        {
          title: 'Pack Pionnier',
          subtitle: "Profite du futur de l'entrainement indoor en exclusivit√©",
          countdownTarget: new Date(import.meta.env.COUNTDOWN_TARGET),
          price: '20',
          period: 'paiement unique',
          items: [
            { description: 'Acc√®s complet √† AeroX pendant 3 mois', icon: 'tabler:award-filled' },
            { description: "1 an d'abonnement √† 50%", icon: 'tabler:currency-euro' },
            { description: 'Canal de discussion exclusif', icon: 'tabler:brand-whatsapp-filled' },
            { description: "Soutiens le d√©veloppement d'AeroX üöÄ", icon: 'tabler:binary-tree-filled' },
          ],
          callToAction: {
            target: '',
            text: 'Deviens pionnier AeroX',
            href: '/inscription/inscription_supabase',
          },
          hasRibbon: true,
          ribbonTitle: 'Pionnier',
        },
        {
          title: 'Pack Progression',
          hasChoice: true,
          title1: 'Annuel',
          subtitle1: "Renforce ta position toute l'ann√©e, √âconomise 30%",
          price1: 140,
          period1: '190‚Ç¨/an √† partir de F√©vrier 2026',
          items1: [
            { description: 'Acc√®s complet √† AeroX', icon: 'tabler:award-filled' },
            { description: "Nouvelles fonctionnalit√©s toute l'ann√©e", icon: 'tabler:binary-tree-filled' },
            { description: 'Id√©al pour pr√©parer s√©rieusement tes objectifs', icon: 'tabler:target-arrow' },
          ],
          callToAction1: {
            target: '_blank',
            text: 'Lancement le 01/12/2025',
            href: '#',
          },
          title2: 'Mensuel',
          subtitle2: 'Renforce ton a√©ro sans engagement',
          price2: 15,
          period2: '22‚Ç¨/mois en F√©vrier 2026',
          items2: [
            { description: 'Acc√®s complet √† AeroX', icon: 'tabler:award-filled' },
            { description: 'Id√©al pour pr√©parer la saison estivale', icon: 'tabler:target-arrow' },
          ],
          callToAction2: {
            target: '_blank',
            text: 'Lancement le 01/11/2025',
            href: '#',
          },
          hasRibbon: false,
          ribbonTitle: '',
        },
      ]}
    />
  </section>
</Layout>
